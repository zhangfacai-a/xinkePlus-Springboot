<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ruoyi.live.mapper.RoomUserRelationMapper">

    <!--
      【备注】采集入库 upsert：
      只更新采集字段(is_follower/is_following/last_watch_time)，
      不更新人工字段(owner_name/follow_status/order_no/remark)，避免被插件覆盖。
    -->
    <insert id="upsert" parameterType="com.ruoyi.live.domain.RoomUserRelation">
        INSERT INTO room_user_relation
        (room_id, user_id, is_follower, is_following, last_watch_time, create_time, update_time)
        VALUES
            (#{roomId}, #{userId}, #{isFollower}, #{isFollowing}, #{lastWatchTime}, NOW(), NOW())
            ON DUPLICATE KEY UPDATE
                                 is_follower = VALUES(is_follower),
                                 is_following = VALUES(is_following),
                                 last_watch_time = VALUES(last_watch_time),
                                 update_time = NOW()
    </insert>

    <!-- 【备注】直播间下用户列表（联表 user + relation），支持筛选 -->
    <select id="selectAudienceList" resultType="com.ruoyi.live.vo.RoomUserAudienceVO">
        SELECT
        r.room_id           AS roomId,
        r.user_id           AS userId,
        u.sec_uid           AS secUid,
        u.nickname          AS nickname,
        u.last_seen_time    AS userLastSeenTime,

        r.is_follower       AS isFollower,
        r.is_following      AS isFollowing,
        r.last_watch_time   AS lastWatchTime,

        r.owner_name        AS ownerName,
        r.follow_status     AS followStatus,
        r.order_no          AS orderNo,
        r.remark            AS remark,

        r.update_time       AS relationUpdateTime
        FROM room_user_relation r
        JOIN room_user_user u ON u.id = r.user_id
        WHERE r.room_id = #{roomId}
        <if test="q != null and q.secUid != null and q.secUid != ''">
            AND u.sec_uid LIKE CONCAT('%', #{q.secUid}, '%')
        </if>
        <if test="q != null and q.nickname != null and q.nickname != ''">
            AND u.nickname LIKE CONCAT('%', #{q.nickname}, '%')
        </if>
        <if test="q != null and q.ownerName != null and q.ownerName != ''">
            AND r.owner_name LIKE CONCAT('%', #{q.ownerName}, '%')
        </if>
        <if test="q != null and q.followStatus != null">
            AND r.follow_status = #{q.followStatus}
        </if>

        <!-- 【新增】按 relationUpdateTime 时间段筛选（r.update_time） -->
        <if test="q != null and q.relationUpdateTimeBegin != null and q.relationUpdateTimeBegin != ''">
            AND r.update_time <![CDATA[>=]]> #{q.relationUpdateTimeBegin}
        </if>
        <if test="q != null and q.relationUpdateTimeEnd != null and q.relationUpdateTimeEnd != ''">
            AND r.update_time <![CDATA[<=]]> #{q.relationUpdateTimeEnd}
        </if>

        <!-- 【修改】默认排序：按 relationUpdateTime 倒序（后添加先显示） -->
        ORDER BY u.last_seen_time DESC
    </select>

    <!-- 【备注】直播间内某个用户详情（user + relation） -->
    <select id="selectAudienceDetail" resultType="com.ruoyi.live.vo.RoomUserAudienceDetailVO">
        SELECT
            r.room_id           AS roomId,
            r.user_id           AS userId,
            u.sec_uid           AS secUid,
            u.nickname          AS nickname,
            u.last_seen_time    AS userLastSeenTime,

            r.is_follower       AS isFollower,
            r.is_following      AS isFollowing,
            r.last_watch_time   AS lastWatchTime,

            r.owner_name        AS ownerName,
            r.follow_status     AS followStatus,
            r.order_no          AS orderNo,
            r.remark            AS remark,

            r.create_time       AS relationCreateTime,
            r.update_time       AS relationUpdateTime
        FROM room_user_relation r
                 JOIN room_user_user u ON u.id = r.user_id
        WHERE r.room_id = #{roomId} AND r.user_id = #{userId}
            LIMIT 1
    </select>

    <!-- 【备注】更新跟进字段（人工维护），不改采集字段 -->
    <update id="updateBizFields" parameterType="com.ruoyi.live.dto.RoomUserBizUpdateReq">
        UPDATE room_user_relation
        SET
            owner_name = #{ownerName},
            follow_status = #{followStatus},
            order_no = #{orderNo},
            remark = #{remark},
            update_time = NOW()
        WHERE room_id = #{roomId} AND user_id = #{userId}
    </update>

</mapper>
